# HG changeset patch
# Parent  83483e973267a892a795eda1f5b5d421bed22031
Bug 1874599 - Add a pref to disable userContextId guessing for external opens;r=mossop

Bug 1692124 improved the behavior for workflows where external opens should move into sessions
inside containers, but it created an issue for those where external opens should move into
the default container and there are also tabs from the same domains inside containers, and
would create extra interstitials with the Multi-Account Containers addon if the predicted
container is different than the "always open" addon setting.

While the heuristic could be improved, it will never be perfect for all workflows,
so this patch introduces a pref to opt out of the behavior (and always open external
links in the default user context ID).

diff --git a/browser/app/profile/firefox.js b/browser/app/profile/firefox.js
--- a/browser/app/profile/firefox.js
+++ b/browser/app/profile/firefox.js
@@ -818,6 +818,9 @@ pref("permissions.desktop-notification.n
 
 pref("permissions.fullscreen.allowed", false);
 
+// Whether to 
+pref("browser.link.external_user_context_guessing.enabled", true);
+
 // handle links targeting new windows
 // 1=current window/tab, 2=new window, 3=new tab in most recent window
 pref("browser.link.open_newwindow", 3);
diff --git a/browser/base/content/browser.js b/browser/base/content/browser.js
--- a/browser/base/content/browser.js
+++ b/browser/base/content/browser.js
@@ -6139,8 +6139,12 @@ nsBrowserAccess.prototype = {
   ) {
     var browsingContext = null;
     var isExternal = !!(aFlags & Ci.nsIBrowserDOMWindow.OPEN_EXTERNAL);
+    var guessUserContextIdEnabled = isExternal && Services.prefs.getBoolPref(
+    "browser.link.external_user_context_guessing.enabled",
+    false
+  );
     var openingUserContextId =
-      (isExternal && URILoadingHelper.guessUserContextId(aURI)) ||
+      (guessUserContextIdEnabled && URILoadingHelper.guessUserContextId(aURI)) ||
       Ci.nsIScriptSecurityManager.DEFAULT_USER_CONTEXT_ID;
 
     if (aOpenWindowInfo && isExternal) {
