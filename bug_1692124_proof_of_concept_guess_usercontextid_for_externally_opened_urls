# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Date 1660671120 25200
#      Tue Aug 16 10:32:00 2022 -0700
# Node ID aa01cd30d1595d972e0295e750975c531fe1e61c
# Parent  af764baf74a1dd0e0b863a8cf26c25266bdcbc14
Bug 1692124 - Guess the userContextId for externally opened URLs

Differential Revision: https://phabricator.services.mozilla.com/D154812

diff --git a/browser/base/content/browser.js b/browser/base/content/browser.js
--- a/browser/base/content/browser.js
+++ b/browser/base/content/browser.js
@@ -6044,6 +6044,9 @@ nsBrowserAccess.prototype = {
   ) {
     var browsingContext = null;
     var isExternal = !!(aFlags & Ci.nsIBrowserDOMWindow.OPEN_EXTERNAL);
+    var openingUserContextId =
+      (isExternal && guessUserContextId(aURI)) ||
+      Ci.nsIScriptSecurityManager.DEFAULT_USER_CONTEXT_ID;
 
     if (aOpenWindowInfo && isExternal) {
       console.error(
@@ -6149,7 +6152,7 @@ nsBrowserAccess.prototype = {
         let forceNotRemote = aOpenWindowInfo && !aOpenWindowInfo.isRemote;
         let userContextId = aOpenWindowInfo
           ? aOpenWindowInfo.originAttributes.userContextId
-          : Ci.nsIScriptSecurityManager.DEFAULT_USER_CONTEXT_ID;
+          : openingUserContextId;
         let browser = this._openURIInNewTab(
           aURI,
           referrerInfo,
@@ -7014,6 +7017,40 @@ function handleLinkClick(event, href, li
   return true;
 }
 
+// Given a URI, guess which container to use to open it. This is used for external
+// openers as a quality of life improvement (e.g. to open a document into the container
+// where you are logged in to the service that hosts it).
+// For now this can only use currently-open tabs, until history is tagged with the
+// container id (https://bugzilla.mozilla.org/show_bug.cgi?id=1283320).
+function guessUserContextId(aURI) {
+  const { host } = aURI;
+  const containerScores = new Map();
+  let guessedUserContextId = null;
+  let maxCount = 0;
+  for (let win of BrowserWindowTracker.orderedWindows) {
+    for (let tab of win.gBrowser.visibleTabs) {
+      let { userContextId } = tab;
+      if (userContextId) {
+        let currentURIHost = null;
+        try {
+          currentURIHost = tab.linkedBrowser.currentURI.host;
+        } catch (e) {}
+
+        if (currentURIHost && currentURIHost == host) {
+          let count = (containerScores.get(userContextId) || 0) + 1;
+          containerScores.set(userContextId, count);
+          if (count > maxCount) {
+            guessedUserContextId = userContextId;
+            maxCount = count;
+          }
+        }
+      }
+    }
+  }
+
+  return guessedUserContextId;
+}
+
 /**
  * Handles paste on middle mouse clicks.
  *
diff --git a/browser/components/contextualidentity/test/browser/browser.toml b/browser/components/contextualidentity/test/browser/browser.toml
--- a/browser/components/contextualidentity/test/browser/browser.toml
+++ b/browser/components/contextualidentity/test/browser/browser.toml
@@ -38,6 +38,8 @@ skip-if = ["true"] # Bug 1541885
 ["browser_imageCache.js"]
 skip-if = ["verify && debug && os == 'win'"]
 
+["browser_guessusercontext.js"]
+
 ["browser_middleClick.js"]
 skip-if = [
   "verify && debug && os == 'linux'",
diff --git a/browser/components/contextualidentity/test/browser/browser_guessusercontext.js b/browser/components/contextualidentity/test/browser/browser_guessusercontext.js
new file mode 100644
--- /dev/null
+++ b/browser/components/contextualidentity/test/browser/browser_guessusercontext.js
@@ -0,0 +1,69 @@
+/* Any copyright is dedicated to the Public Domain.
+   http://creativecommons.org/publicdomain/zero/1.0/ */
+
+"use strict";
+
+const PERSONAL = 1;
+const WORK = 2;
+const HOST_MOCHI = new URL(
+  "http://mochi.test:8888/browser/browser/components/contextualidentity/test/browser/blank.html"
+);
+const HOST_EXAMPLE = new URL(
+  "https://example.com/browser/browser/components/contextualidentity/test/browser/blank.html"
+);
+
+const { guessUserContextId } = gBrowser.ownerGlobal;
+
+async function openTabInUserContext(uri, userContextId, win = window) {
+  let { gBrowser } = win;
+  let tab = BrowserTestUtils.addTab(gBrowser, uri, { userContextId });
+  gBrowser.selectedTab = tab;
+  tab.ownerGlobal.focus();
+  await BrowserTestUtils.browserLoaded(gBrowser.getBrowserForTab(tab));
+  return tab;
+}
+
+registerCleanupFunction(async function cleanup() {
+  while (gBrowser.tabs.length > 1) {
+    gBrowser.removeTab(gBrowser.selectedTab, { animate: false });
+  }
+});
+
+add_setup(async function () {
+  await SpecialPowers.pushPrefEnv({
+    set: [["privacy.userContext.enabled", true]],
+  });
+});
+
+add_task(async function test() {
+  is(guessUserContextId(HOST_EXAMPLE), null, "no tabs - null");
+  await openTabInUserContext(HOST_EXAMPLE.href, PERSONAL);
+  is(guessUserContextId(HOST_EXAMPLE), PERSONAL, "one tab - matches container");
+  is(guessUserContextId(HOST_MOCHI), null, "one tab - doesn't match container");
+  await openTabInUserContext(HOST_EXAMPLE.href, WORK);
+  is(guessUserContextId(HOST_EXAMPLE), PERSONAL, "same number - use first");
+  await openTabInUserContext(HOST_EXAMPLE.href, WORK);
+  is(guessUserContextId(HOST_EXAMPLE), WORK, "multiple per host - max");
+
+  let win = await BrowserTestUtils.openNewBrowserWindow();
+  await openTabInUserContext(HOST_EXAMPLE.href, PERSONAL, win);
+  await openTabInUserContext(HOST_EXAMPLE.href, PERSONAL, win);
+  is(guessUserContextId(HOST_EXAMPLE), PERSONAL, "count across windows");
+
+  await BrowserTestUtils.closeWindow(win);
+  is(guessUserContextId(HOST_EXAMPLE), WORK, "forgets closed window");
+
+  // Check the opener flow
+  let loaded = BrowserTestUtils.browserLoaded(gBrowser.selectedBrowser);
+  window.browserDOMWindow.openURI(
+    makeURI(HOST_EXAMPLE.href + "?new"),
+    null,
+    Ci.nsIBrowserDOMWindow.OPEN_NEWTAB,
+    Ci.nsIBrowserDOMWindow.OPEN_EXTERNAL,
+    Services.scriptSecurityManager.getSystemPrincipal()
+  );
+  await loaded;
+  is(gBrowser.selectedTab.getAttribute("usercontextid"), WORK, "opener flow");
+  is(guessUserContextId(HOST_EXAMPLE), WORK, "still the most common");
+  is(guessUserContextId(HOST_MOCHI), null, "still doesn't match container");
+});
